\documentclass[tikz,border=6pt,12pt]{standalone}
\usepackage{tikz}
\usetikzlibrary{positioning,automata,fit,arrows.meta,calc,quotes}

\begin{document}
\begin{tikzpicture}[
    font=\sffamily\small,
    teeBlue/.style={fill=blue!10,draw=blue!60,thick,rounded corners=2pt},
    box/.style    ={draw=black!70,rounded corners=2pt,thick,align=center},
    lbl/.style    ={font=\sffamily\bfseries},
    arrow/.style  ={->,>={Stealth[length=3mm,width=2mm]},thick},
]

\tikzset{
  pics/padlock/.style={
    code={
      \draw[line width=2pt,draw=blue!60]
        (-0.15,0) arc (180:0:0.15 and 0.1) -- ++(0,-0.2) -- ++(-0.3,0) -- cycle;
      \draw[line width=1pt,fill=blue!40,draw=blue!60]
        (-0.25,-0.2) rectangle (0.25,-0.6);
    }
  }
}

% ---------- Parameters (all unit-less, treated as cm later) ----------
\def\W{7.0}    % total width
\def\Htop{4.1}  % TEE height
\def\Hbot{2.8}  % platform height
\def\gap{0.5}   % vertical gap
\def\pad{0.2}   % inner padding

\def\leftW{4.7} % left column width inside TEE
\def\rowH{1.2}  % row height for left-column boxes

% Derived widths (unit-less numbers)
\pgfmathsetmacro{\cpuW}{\W - 7.2 - 2*\pad - 0.5}

% ---------- Top: VM-Level TEE ----------
\node[teeBlue, minimum width=\W cm, minimum height=\Htop cm, anchor=north west] (TEE) at (0,0) {};

\node[anchor=north, lbl]
	at ([xshift=0pt,yshift=0pt]TEE.north) {TEE in Cloud};
\node[anchor=north east, xshift=-10pt,yshift=-10pt] at (TEE.north east) {\large ðŸ”’};


% Left column (three stacked boxes)

\node[box, minimum width=2.5 cm, minimum height=\rowH cm,  fill=white, anchor=north west]
(APP) at ([xshift=\pad cm, yshift=-.7 cm]TEE.north west) {Data Processing\\Program};

\node[box, densely dashed, minimum width=3.1 cm, minimum height=1.4 cm, anchor=center, line width=1.2pt, draw=blue]
(BOX) at ([]APP.center){};

\node[box, minimum width=1.8 cm, minimum height=\rowH cm, draw=red!70,line width=1pt, anchor=north east, fill=white]
  (SD) at ([xshift= -\pad cm,yshift=-.7 cm]TEE.north east) {Personal\\Data};

\node[box, minimum width=1.8 cm, minimum height=\rowH cm, anchor=south, fill=white,draw=blue]
  (M) at ([xshift=.0cm, yshift=\pad cm]TEE.south) {Trusted\\Mediator};


% ---------- Bottom: Untrusted Cloud Platform ----------

% VMM (left)
\node[box, fill=white, minimum width=2.5cm, minimum height=\rowH cm, anchor=north]
      (SP) at ([xshift=0 cm,yshift=-3 cm]APP.south) {Service\\Provider};

% Trusted CPU Features (right)
\node[box, fill=white, minimum width=1.8cm, minimum height=\rowH cm, anchor=north]
      (SU) at ([xshift=0 cm,yshift=-3 cm]SD.south) {Service\\User};


    % \draw[arrow] (SP) -- node [] {Provides} -- (APP)  ;
% \path[arrow] 
	% (SP) edge["provides"] (APP)
	% (SU) edge["provides"] (SD)
	% (M) edge["prevent leaks" swap] (APP)
	% (APP) edge["process" ] (SD)
	% (SU) edge["trust"] (M)
	% (SP) edge["trust" swap] (M)
	% ;
\draw[arrow,color=blue, densely dashed] (M) -- (BOX) 
	node[midway,right,text width=2.5cm,align=right,yshift=.1cm,xshift=-.6cm]{prevents data leaks};
\draw[arrow,dotted] (SP) -- (APP) node[midway,sloped,above]{provides};
\draw[arrow,dotted] (SU) -- (SD) node[midway,sloped,above]{provides};
\draw[arrow,<->] (APP) -- (SD) node[midway, above]{process};
\draw[arrow,draw=blue] (SU) -- (M) node[midway,below,sloped]{trust};
\draw[arrow,draw=blue] (SP) -- (M) node[midway,below,sloped]{trust};
\draw[arrow,<->,draw=red] (SP) -- (SU) node[midway,below,sloped]{distrusting} -- (SP);
% Padlocks
% \pic at ([xshift=-12pt,yshift=20pt]ENC.north east) {padlock};
% \pic at ([xshift=0pt,yshift=4pt]CPU.north east) {padlock};

\end{tikzpicture}
\end{document}
